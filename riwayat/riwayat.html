<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Riwayat Aktivitas Pengguna</title>
  <link rel="stylesheet" href="riwayat.css" />
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-brand">RaGi (Ranah Digital)</div>
      <div class="navbar-menu">
        <a href="../index/index.html" class="nav-link">Beranda</a>
        <a href="../layanan/layanan.html" class="nav-link">Layanan</a>
        <a href="../tentang/tentang.html" class="nav-link">Tentang</a>
        <a href="riwayat.html" class="nav-link active">Riwayat</a>
      </div>
      <div class="navbar-profile">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">Memuat riwayat aktivitas...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="error-container" style="display:none;">
      <div class="error-card">
        <div class="error-icon">⚠️</div>
        <h3>Terjadi Kesalahan</h3>
        <p id="error-message">Gagal memuat data</p>
        <button id="btnRetry" class="btn-retry">Coba Lagi</button>
      </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display:none;">
      <div class="header">
        <h1>Riwayat Aktivitas</h1>
        <p class="subtitle">Pantau semua kegiatan dan transaksi dokumen Anda</p>
      </div>

      <!-- Filter & Search -->
      <div class="filter-card">
        <div class="filter-grid">
          <div class="input-wrapper">
            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" id="searchInput" placeholder="Cari aktivitas..." class="input-field" />
          </div>

          <div class="input-wrapper">
            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            <select id="filterType" class="select-field">
              <option value="all">Semua Aktivitas</option>
              <option value="registration">Pendaftaran</option>
              <option value="download">Unduhan</option>
              <option value="verification">Verifikasi</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Activity List -->
      <div id="activityList" class="activity-list"></div>

      <!-- Empty State -->
      <div id="emptyState" class="empty-state" style="display:none;">
        <div class="empty-icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
        <h3>Tidak Ada Aktivitas</h3>
        <p>Tidak ditemukan aktivitas yang sesuai dengan pencarian Anda</p>
      </div>

      <!-- Stats Summary -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number stat-blue" id="totalActivities">0</div>
          <div class="stat-label">Total Aktivitas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number stat-green" id="completedActivities">0</div>
          <div class="stat-label">Selesai</div>
        </div>
        <div class="stat-card">
          <div class="stat-number stat-yellow" id="processingActivities">0</div>
          <div class="stat-label">Diproses</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== STATE ======
    let allActivities = [];
    let filteredActivities = [];

    // ====== ICONS ======
    const icons = {
      UserPlus: `<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="22" x2="16" y1="11" y2="11"></line>`,
      Download: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line>`,
      FileText: `<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" x2="8" y1="13" y2="13"></line><line x1="16" x2="8" y1="17" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>`,
      FileCheck: `<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><polyline points="9 15 11 17 15 13"></polyline>`,
      Calendar: `<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>`,
      Clock: `<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>`
    };

    // ====== INIT ======
    document.addEventListener("DOMContentLoaded", () => {
      setupEventListeners();
      fetchActivities();
      document.getElementById("btnRetry").addEventListener("click", fetchActivities);
    });

    function setupEventListeners() {
      const searchInput = document.getElementById("searchInput");
      const filterType = document.getElementById("filterType");

      searchInput.addEventListener("input", () => {
        filterActivities(searchInput.value, filterType.value);
      });

      filterType.addEventListener("change", () => {
        filterActivities(searchInput.value, filterType.value);
      });
    }

    // ====== API FETCH (REAL DB) ======
    async function fetchActivities() {
      try {
        showLoading();

        const res = await fetch("../ragi_api/get_riwayat.php", {
          method: "GET",
          credentials: "include"
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          // kalau belum login, arahkan ke login
          if (res.status === 401) {
            alert(data.message || "Silakan login dulu");
            window.location.href = "/ragi/html/login/login.html";
            return;
          }
          throw new Error(data.message || "Gagal mengambil data riwayat");
        }

        // data.items berasal dari API
        allActivities = mapDbToUi(data.items || []);
        filteredActivities = allActivities;

        renderActivities();
        updateStats();
        showMainContent();

      } catch (err) {
        showError(err.message);
      }
    }

    // ====== MAPPING DB -> UI MODEL ======
    function mapDbToUi(items) {
      // items: [{id, tracking_code, service_type, status, submitted_at, files:[...]}]
      return items.map((a) => {
        const service = (a.service_type || "").toUpperCase();
        const titleMap = {
          KTP: "Pendaftaran KTP",
          KK: "Pendaftaran Kartu Keluarga",
          AKTA_KELAHIRAN: "Pendaftaran Akta Kelahiran",
          SKTM: "Pendaftaran SKTM"
        };

        const title = titleMap[service] || ("Pengajuan " + service);
        const description = `Tracking: ${a.tracking_code}`;
        const status = mapStatus(a.status);
        const icon = service === "KTP" ? "FileCheck" : "FileText";

        return {
          id: a.id,
          type: "registration",
          title,
          description,
          date: a.submitted_at,
          status,
          icon,
          files: a.files || []
        };
      });
    }

    function mapStatus(dbStatus) {
      const s = (dbStatus || "").toUpperCase();
      if (["APPROVED", "DONE", "SELESAI", "COMPLETED"].includes(s)) return "completed";
      if (["REJECTED", "DITOLAK"].includes(s)) return "rejected";
      return "processing";
    }

    // ====== FILTER ======
    function filterActivities(searchTerm, filterType) {
      const q = (searchTerm || "").toLowerCase();

      filteredActivities = allActivities.filter((activity) => {
        const matchesSearch =
          activity.title.toLowerCase().includes(q) ||
          activity.description.toLowerCase().includes(q);

        const matchesFilter = filterType === "all" || activity.type === filterType;

        return matchesSearch && matchesFilter;
      });

      renderActivities();
    }

    // ====== RENDER ======
    function renderActivities() {
      const listContainer = document.getElementById("activityList");
      const emptyState = document.getElementById("emptyState");

      if (filteredActivities.length === 0) {
        listContainer.style.display = "none";
        emptyState.style.display = "block";
        return;
      }

      listContainer.style.display = "flex";
      emptyState.style.display = "none";

      listContainer.innerHTML = filteredActivities
        .map((activity) => {
          const date = new Date(String(activity.date).replace(" ", "T"));
          const formattedDate = date.toLocaleDateString("id-ID", {
            day: "numeric",
            month: "long",
            year: "numeric"
          });
          const formattedTime = date.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit"
          });

          // tampilkan link file (kalau ada)
          const filesHtml = (activity.files || []).slice(0, 4).map((f) => {
            // stored_path kamu contoh: uploads/xxx -> url jadi /ragi_api/uploads/xxx
            const url = "/ragi_api/" + f.stored_path;
            return `<a href="${url}" target="_blank" style="margin-right:10px; text-decoration:underline;">
                      ${f.file_kind}
                    </a>`;
          }).join("");

          return `
            <div class="activity-card">
              <div class="activity-content">
                <div class="activity-icon">
                  <svg viewBox="0 0 24 24">${icons[activity.icon] || icons.FileText}</svg>
                </div>
                <div class="activity-body">
                  <div class="activity-header">
                    <h3 class="activity-title">${activity.title}</h3>
                    <span class="status-badge status-${activity.status}">
                      ${getStatusText(activity.status)}
                    </span>
                  </div>

                  <p class="activity-description">
                    ${activity.description}
                    ${filesHtml ? `<br><small>File: ${filesHtml}</small>` : ""}
                  </p>

                  <div class="activity-meta">
                    <div class="meta-item">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        ${icons.Calendar}
                      </svg>
                      <span>${formattedDate}</span>
                    </div>
                    <div class="meta-item">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        ${icons.Clock}
                      </svg>
                      <span>${formattedTime} WIB</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="activity-border"></div>
            </div>
          `;
        })
        .join("");
    }

    function updateStats() {
      const total = allActivities.length;
      const completed = allActivities.filter((a) => a.status === "completed").length;
      const processing = allActivities.filter((a) => a.status === "processing").length;

      document.getElementById("totalActivities").textContent = total;
      document.getElementById("completedActivities").textContent = completed;
      document.getElementById("processingActivities").textContent = processing;
    }

    function getStatusText(status) {
      const statusMap = {
        completed: "Selesai",
        processing: "Diproses",
        rejected: "Ditolak"
      };
      return statusMap[status] || "Menunggu";
    }

    // ====== UI STATES ======
    function showLoading() {
      document.getElementById("loading").style.display = "flex";
      document.getElementById("error").style.display = "none";
      document.getElementById("main-content").style.display = "none";
    }

    function showError(message) {
      document.getElementById("loading").style.display = "none";
      document.getElementById("error").style.display = "flex";
      document.getElementById("main-content").style.display = "none";
      document.getElementById("error-message").textContent = message;
    }

    function showMainContent() {
      document.getElementById("loading").style.display = "none";
      document.getElementById("error").style.display = "none";
      document.getElementById("main-content").style.display = "block";
    }
  </script>
</body>
</html>
